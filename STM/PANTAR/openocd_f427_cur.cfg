# ---- ST-LINK + STM32F427IIHx (SWD, robust under-reset attach) ----
source [find interface/stlink-dap.cfg]
transport select "dapdirect_swd"

set WORKAREASIZE 0x8000
set CHIPNAME  STM32F427IIHx
set BOARDNAME genericBoard

# 让 stm32f4x.cfg 在 halt 时冻结看门狗、低功耗下保留调试
set ENABLE_LOW_POWER 1
set STOP_WATCHDOG   1

# 先用低速，连稳后可改 480 / 1000 / 4000
set CLOCK_FREQ 50
adapter speed $CLOCK_FREQ

# 有 NRST，连接时按住复位；延时加长
reset_config srst_only srst_nogate connect_assert_srst
set CONNECT_UNDER_RESET 1
set CORE_RESET 0
adapter srst delay 400        ;# 复位保持/释放后的等待时间（ms）

# 目标与端口
set AP_NUM   0
set GDB_PORT 3333
source [find target/stm32f4x.cfg]

# ——关键时序增强——
# 1) GDB 附着瞬间：先 reset halt，再等一会儿，确保停住
$_TARGETNAME configure -event gdb-attach {
    reset halt
    sleep 500
}

# 2) 开始擦写前也再稳一次（避免跑飞导致擦写失败）
$_TARGETNAME configure -event gdb-flash-erase-start {
    reset halt
    sleep 500
}

# （可选）脱离时继续运行
# $_TARGETNAME configure -event gdb-detach { resume }

